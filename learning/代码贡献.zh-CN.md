# 开始为 Project AIRI 贡献（中文翻译）

原文链接: [airi/.github/CONTRIBUTING.md at main · moeru-ai/airi](https://github.com/moeru-ai/airi/blob/main/.github/CONTRIBUTING.md)

你好！感谢你对本项目的关注。此指南将帮助你入门并快速开始贡献。

## 前置条件

- 已安装 Git（https://git-scm.com/downloads）
- 已安装 Node.js（建议 23+，https://nodejs.org/）
- corepack（https://github.com/nodejs/corepack）
- pnpm（https://pnpm.io/installation）

<details>
<summary>Windows 环境设置</summary>

0. 下载 Visual Studio（https://visualstudio.microsoft.com/downloads/），并按照此处说明安装：
   https://rust-lang.github.io/rustup/installation/windows-msvc.html#walkthrough-installing-visual-studio-2022

   > 安装时请确保选择 Windows SDK 和 C++ 构建工具。

1. 打开 PowerShell
2. 安装 scoop（https://scoop.sh/）

   ```powershell
   Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
   Invoke-RestMethod -Uri https://get.scoop.sh | Invoke-Expression
   ```

3. 通过 scoop 安装 git、Node.js、rustup、msvc

   ```powershell
   scoop install git nodejs rustup

   # 如果需要构建 Rust 相关仓库/应用（可选）
   scoop install main/rust-msvc
   rustup toolchain install stable-x86_64-pc-windows-msvc
   rustup default stable-x86_64-pc-windows-msvc
   ```

   > 参考： https://stackoverflow.com/a/64121601

4. 使用 corepack 安装 pnpm

   ```powershell
   corepack enable
   corepack prepare pnpm@latest --activate
   ```

</details>

<details>
<summary>macOS 环境设置</summary>

0. 打开终端（Terminal / iTerm2 等）
1. 使用 Homebrew 安装 git 和 node

   ```shell
   brew install git node
   ```

2. 使用 corepack 安装 pnpm

   ```shell
   corepack enable
   corepack prepare pnpm@latest --activate
   ```

</details>

<details>
<summary>Linux 环境设置</summary>

0. 打开终端
1. 按照 NodeSource 的说明安装 Node.js（https://github.com/nodesource/distributions）
2. 安装 git（参见 https://git-scm.com/downloads/linux）
3. 使用 corepack 安装 pnpm

   ```shell
   corepack enable
   corepack prepare pnpm@latest --activate
   ```

4. 如果你要开发桌面版本（Tamagotchi），还需要安装下列依赖：

   ```shell
   sudo apt install \
      libssl-dev \
      libglib2.0-dev \
      libgtk-3-dev \
      libjavascriptcoregtk-4.1-dev \
      libwebkit2gtk-4.1-dev
   ```

</details>

## 如果你之前已经为本项目贡献过

> [!WARNING]
>
> 如果你没有克隆本仓库，请跳过本节。

请确保本地仓库与上游（upstream）同步：

```shell
git fetch --all
git checkout main
git pull upstream main --rebase
```

如果你有正在开发的分支，需要将其与上游的 main 保持同步：

```shell
git checkout <your-branch-name>
git rebase main
```

## Fork 本项目

在 https://github.com/moeru-ai/airi 页面右上角点击 **Fork** 按钮。

## 克隆（Clone）

```shell
git clone https://github.com/<your-github-username>/airi.git
cd airi
```

## 创建工作分支

```shell
git checkout -b <your-branch-name>
```

## 安装依赖

```shell
corepack enable
pnpm install

# 若涉及 Rust 依赖（可选）
cargo fetch
```

> [!NOTE]
>
> 我们建议安装 [@antfu/ni](https://github.com/antfu-collective/ni) 以简化脚本：
>
> ```shell
> corepack enable
> npm i -g @antfu/ni
> ```
>
> 安装后你可以：
>
> - 使用 `ni` 代替 `pnpm install`、`npm install` 或 `yarn install`。
> - 使用 `nr` 代替 `pnpm run`、`npm run` 或 `yarn run`。

## 选择你想开发的应用

### Stage Tamagotchi（桌面）

```shell
pnpm dev:tamagotchi
```

> [!NOTE]
>
> 使用 `ni` 的话：
>
> ```shell
> nr dev:tamagotchi
> ```

### Stage Web（浏览器端，airi.moeru.ai）

```shell
pnpm dev
```

> [!NOTE]
>
> 使用 `ni` 的话：
>
> ```shell
> nr dev
> ```

### 文档站点

```shell
pnpm dev:docs
```

> [!NOTE]
>
> 使用 `ni` 的话：
>
> ```shell
> nr dev:docs
> ```

### Telegram 机器人集成

需要一个 Postgres 数据库。

```shell
cd services/telegram-bot
docker compose up -d
```

配置 `.env`

```shell
cp .env .env.local
```

编辑 `.env.local` 中的凭据。

迁移数据库

```shell
pnpm -F @proj-airi/telegram-bot db:generate
pnpm -F @proj-airi/telegram-bot db:push
```

运行机器人

```shell
pnpm -F @proj-airi/telegram-bot start
```

> [!NOTE]
>
> 使用 `ni` 的话：
>
> ```shell
> nr -F @proj-airi/telegram-bot dev
> ```

### Discord 机器人集成

```shell
cd services/discord-bot

cp .env .env.local
# 编辑 .env.local 中的凭据

pnpm -F @proj-airi/discord-bot start
```

> [!NOTE]
>
> 使用 `ni` 的话：
>
> ```shell
> nr -F @proj-airi/discord-bot dev
> ```

### Minecraft agent

```shell
cd services/minecraft
```

启动 Minecraft 客户端并导出世界到指定端口，然后在 `.env.local` 中填入该端口。

配置 `.env`

```shell
cp .env .env.local
```

编辑 `.env.local` 中的凭据。

运行机器人

```shell
pnpm -F @proj-airi/minecraft-bot start
```

> [!NOTE]
>
> 使用 `ni` 的话：
>
> ```shell
> nr -F @proj-airi/minecraft-bot dev
> ```

## 提交（Commit）

### 提交前

请确保静态检查（lint）和 TypeScript 类型检查通过：

```shell
pnpm lint && pnpm typecheck
```

如果你要提交图片，考虑使用 AVIF 格式以减少体积。可通过下列命令把图片转换为 AVIF：

```shell
pnpm to-avif <PATH_TO_IMAGE_OR_DIRECTORY1> <PATH_2> <PATH_3> ...
```

> [!NOTE]
>
> 使用 `ni` 的话：
>
> ```shell
> nr lint && nr typecheck
> ```

### 提交

```shell
git add .
git commit -m "<your-commit-message>"
```

### 推送到你的 fork

```shell
git push origin <your-branch-name> -u
```

你现在应该能在你的 fork 上看到分支。

> [!NOTE]
>
> 如果这是你第一次为本项目贡献，请添加 upstream：
>
> ```shell
> git remote add upstream https://github.com/moeru-ai/airi.git
> ```

## 创建 Pull Request

打开 https://github.com/moeru-ai/airi，点击 **Pull requests** → **New pull request**，选择 **Compare across forks**，选择你的 fork 并创建 PR。

## 恭喜！

你已成功完成第一次贡献。现在等待维护者审阅你的 PR 即可。
