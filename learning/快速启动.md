# 启动服务指南

本文档说明如何在本仓库（monorepo）中在本地启动开发服务与构建产物。适用于 Windows + PowerShell（默认 shell）。

## 前置要求

- Node.js（推荐 23+）
- pnpm（仓库声明使用 pnpm@10.18.2），可通过 `npm i -g pnpm@10.18.2` 安装
- Rust（只有当需要构建 Rust crates 时）：安装 rustup 和 cargo

## 安装依赖

在仓库根目录运行：

```powershell
pnpm install
```

这会安装所有工作区依赖并执行 `postinstall` 钩子（如有）。

## 常用开发脚本

在根目录可通过 npm script 启动各类服务，示例：

- 启动默认前端（stage-web）

```powershell
pnpm run dev:web
```

- 启动后端开发服务（server-runtime）

```powershell
pnpm run dev:server
```

- 启动 Tamagotchi 桌面/应用

```powershell
pnpm run dev:tamagotchi
```

- 并行启动 `apps` 下的所有应用（在多个终端/标签页中运行更稳定）

```powershell
pnpm run dev:apps
```

- 并行启动 `packages` 下的所有包（开发模式）

```powershell
pnpm run dev:packages
```

- 在根目录启动仓库中默认 dev（等同于打开 `stage-web`）

```powershell
pnpm run dev
```

## 构建（生产/打包）

- 构建所有 app 和 package：

```powershell
pnpm run build
```

- 仅构建 packages：

```powershell
pnpm run build:packages
```

- 构建 Rust crates（需要已安装 Rust）：

```powershell
pnpm run build:crates
# 或直接
cargo build --workspace
```

## 推荐工作流

- 在开发多个服务时，在 VS Code 中为每个服务打开独立终端并运行对应 `pnpm run dev:*`。
- 若需要一次性更新依赖并清理：

```powershell
pnpm run up
```

## 常见问题与排查

- 端口冲突：检查已运行的本地服务并停止占用端口的进程。
- 依赖安装失败：确认 pnpm 版本与网络可达性，必要时清理缓存 `pnpm store prune` 或删除 `node_modules` 与 `pnpm-lock.yaml` 后重装。
- Rust 构建失败：确认已安装正确的 toolchain（`rustup default stable`）并运行 `cargo build --workspace` 查看详细错误。
