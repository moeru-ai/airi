# 路由机制

<cite>
**Referenced Files in This Document**   
- [apps/stage-web/src/pages/[...all].vue](file://apps/stage-web/src/pages/[...all].vue)
- [apps/stage-web/vite.config.ts](file://apps/stage-web/vite.config.ts)
- [apps/stage-web/src/main.ts](file://apps/stage-web/src/main.ts)
- [apps/stage-web/src/layouts/default.vue](file://apps/stage-web/src/layouts/default.vue)
- [apps/stage-web/src/layouts/home.vue](file://apps/stage-web/src/layouts/home.vue)
- [apps/stage-web/src/layouts/stage.vue](file://apps/stage-web/src/layouts/stage.vue)
- [apps/stage-web/src/layouts/plain.vue](file://apps/stage-web/src/layouts/plain.vue)
- [apps/stage-web/src/modules/i18n.ts](file://apps/stage-web/src/modules/i18n.ts)
- [apps/stage-web/src/typed-router.d.ts](file://apps/stage-web/src/typed-router.d.ts)
</cite>

## 目录
1. [项目结构](#项目结构)
2. [通配符路由实现](#通配符路由实现)
3. [文件系统路由自动生成](#文件系统路由自动生成)
4. [路由历史模式配置](#路由历史模式配置)
5. [布局系统集成](#布局系统集成)
6. [国际化路由支持](#国际化路由支持)
7. [类型安全路由](#类型安全路由)

## 项目结构

stage-web应用的路由系统基于Vue Router的文件系统自动生成机制，通过Vite插件实现。项目中的`src/pages`目录包含了所有路由页面组件，包括通配符路由`[...all].vue`。

```mermaid
graph TB
subgraph "路由核心"
ViteConfig["vite.config.ts\n(VueRouter插件)"]
PagesDir["src/pages\n(页面组件目录)"]
MainTs["main.ts\n(路由初始化)"]
end
subgraph "布局系统"
LayoutsDir["src/layouts\n(布局组件)"]
LayoutsPlugin["vite-plugin-vue-layouts"]
end
subgraph "类型系统"
TypedRouter["typed-router.d.ts\n(类型生成)"]
end
ViteConfig --> PagesDir
ViteConfig --> LayoutsPlugin
MainTs --> ViteConfig
LayoutsPlugin --> LayoutsDir
ViteConfig --> TypedRouter
```

**Diagram sources**
- [vite.config.ts](file://apps/stage-web/vite.config.ts#L1-L180)
- [main.ts](file://apps/stage-web/src/main.ts#L1-L52)

**Section sources**
- [pages](file://apps/stage-web/src/pages)
- [layouts](file://apps/stage-web/src/layouts)

## 通配符路由实现

通配符路由`[...all].vue`用于处理所有未匹配的路径请求，实现错误页面的降级处理策略。该组件通过Vue Router的路由参数捕获所有路径段，并提供用户友好的回退界面。

```mermaid
sequenceDiagram
participant Browser as "浏览器"
participant Router as "Vue Router"
participant AllRoute as "[...all].vue"
Browser->>Router : 请求未定义路径
Router->>Router : 匹配[...all]通配符路由
Router->>AllRoute : 激活组件
AllRoute->>AllRoute : 显示错误信息
AllRoute->>AllRoute : 提供返回按钮
AllRoute-->>Browser : 渲染错误页面
```

**Diagram sources**
- [apps/stage-web/src/pages/[...all].vue](file://apps/stage-web/src/pages/[...all].vue#L1-L20)

**Section sources**
- [apps/stage-web/src/pages/[...all].vue](file://apps/stage-web/src/pages/[...all].vue#L1-L20)

## 文件系统路由自动生成

路由系统通过`unplugin-vue-router`插件实现基于文件系统的自动路由生成。插件扫描指定的页面目录，根据文件路径和命名约定自动生成路由配置，无需手动定义路由表。

```mermaid
flowchart TD
Start([启动构建]) --> ScanPages["扫描页面目录\nsrc/pages & stage-pages/src/pages"]
ScanPages --> AnalyzeFiles["分析文件结构\n识别动态路由参数"]
AnalyzeFiles --> GenerateRoutes["生成路由配置\n创建路由记录"]
GenerateRoutes --> CreateTypes["生成类型定义\ntyped-router.d.ts"]
CreateTypes --> RegisterRoutes["注册路由\nVue Router"]
RegisterRoutes --> End([路由系统就绪])
```

**Diagram sources**
- [vite.config.ts](file://apps/stage-web/vite.config.ts#L1-L180)

**Section sources**
- [vite.config.ts](file://apps/stage-web/vite.config.ts#L1-L180)

## 路由历史模式配置

应用根据环境变量动态选择路由历史模式，支持哈希模式和HTML5历史模式。在Hugging Face Space部署时使用哈希模式，其他环境使用HTML5历史模式，确保在不同部署环境下的路由兼容性。

```mermaid
graph TD
A[应用启动] --> B{环境变量\nVITE_APP_TARGET_HUGGINGFACE_SPACE}
B --> |true| C[创建哈希历史\ncreateWebHashHistory]
B --> |false| D[创建HTML5历史\ncreateWebHistory]
C --> E[初始化路由器]
D --> E
E --> F[路由守卫\nNProgress]
F --> G[路由系统就绪]
```

**Diagram sources**
- [main.ts](file://apps/stage-web/src/main.ts#L1-L52)

**Section sources**
- [main.ts](file://apps/stage-web/src/main.ts#L1-L52)

## 布局系统集成

路由系统与`vite-plugin-vue-layouts`插件集成，实现基于布局的页面结构管理。不同页面可以指定不同的布局组件，通过`setupLayouts`函数将路由记录与布局系统关联，实现灵活的页面布局配置。

```mermaid
classDiagram
class LayoutsPlugin {
+setupLayouts(routes)
+resolveLayout(route)
}
class LayoutComponent {
+<template>
+<RouterView/>
}
class RouteRecord {
+name
+path
+meta.layout
}
LayoutsPlugin --> RouteRecord : "处理"
LayoutComponent --> LayoutsPlugin : "提供"
RouteRecord --> LayoutComponent : "引用"
note right of LayoutsPlugin
根据路由元数据
自动应用对应布局
end
```

**Diagram sources**
- [vite.config.ts](file://apps/stage-web/vite.config.ts#L1-L180)
- [default.vue](file://apps/stage-web/src/layouts/default.vue#L1-L31)
- [home.vue](file://apps/stage-web/src/layouts/home.vue#L1-L21)
- [stage.vue](file://apps/stage-web/src/layouts/stage.vue#L1-L10)
- [plain.vue](file://apps/stage-web/src/layouts/plain.vue#L1-L4)

**Section sources**
- [vite.config.ts](file://apps/stage-web/vite.config.ts#L1-L180)
- [layouts](file://apps/stage-web/src/layouts)

## 国际化路由支持

路由系统与Vue I18n集成，支持多语言路由。通过`@intlify/unplugin-vue-i18n/vite`插件自动加载语言包，并根据浏览器语言设置和本地存储的用户偏好选择合适的语言环境，实现无缝的国际化体验。

```mermaid
sequenceDiagram
participant App as "应用"
participant I18n as "Vue I18n"
participant Storage as "localStorage"
participant Browser as "浏览器"
App->>Storage : 读取 settings/language
Storage-->>App : 语言设置
alt 有设置
App->>I18n : 使用存储的语言
else 无设置
App->>Browser : 获取 navigator.language
Browser-->>App : 浏览器语言
App->>App : 映射到支持的语言
App->>I18n : 使用映射后的语言
end
I18n->>I18n : 加载对应语言包
I18n-->>App : 初始化i18n实例
```

**Diagram sources**
- [i18n.ts](file://apps/stage-web/src/modules/i18n.ts#L1-L50)

**Section sources**
- [i18n.ts](file://apps/stage-web/src/modules/i18n.ts#L1-L50)

## 类型安全路由

系统通过`unplugin-vue-router`插件生成类型安全的路由定义，确保路由使用时的类型检查。生成的`typed-router.d.ts`文件包含所有路由的类型信息，支持IDE的自动补全和编译时检查，减少路由相关的运行时错误。

```mermaid
flowchart LR
A[页面文件] --> B["unplugin-vue-router"]
B --> C[typed-router.d.ts]
C --> D[类型检查]
D --> E[IDE自动补全]
E --> F[安全的路由使用]
subgraph "类型安全优势"
G[路由名称检查]
H[参数类型检查]
I[避免拼写错误]
end
F --> G
F --> H
F --> I
```

**Diagram sources**
- [typed-router.d.ts](file://apps/stage-web/src/typed-router.d.ts#L7-L310)

**Section sources**
- [typed-router.d.ts](file://apps/stage-web/src/typed-router.d.ts#L7-L310)