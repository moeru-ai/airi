# 安装程序配置

<cite>
**本文档中引用的文件**  
- [electron-builder.yml](file://apps/stage-tamagotchi/electron-builder.yml)
- [package.json](file://apps/stage-tamagotchi/package.json)
- [entitlements.mac.plist](file://apps/stage-tamagotchi/build/entitlements.mac.plist)
- [scripts/utils.ts](file://apps/stage-tamagotchi/scripts/utils.ts)
- [scripts/rename-artifacts.ts](file://apps/stage-tamagotchi/scripts/rename-artifacts.ts)
- [scripts/artifacts-metadata.ts](file://apps/stage-tamagotchi/scripts/artifacts-metadata.ts)
</cite>

## 目录
1. [简介](#简介)
2. [应用基本信息配置](#应用基本信息配置)
3. [输出与资源管理](#输出与资源管理)
4. [平台特定配置](#平台特定配置)
   - [Windows (NSIS)](#windows-nsis)
   - [macOS (DMG)](#macos-dmg)
   - [Linux (DEB/RPM)](#linux-deb-rpm)
5. [图标与权限配置](#图标与权限配置)
6. [安装包命名与构建脚本](#安装包命名与构建脚本)
7. [依赖与性能优化](#依赖与性能优化)

## 简介
本文档详细解析 `electron-builder.yml` 文件中的各项配置，涵盖应用基本信息、多平台打包设置、安装向导定制、图标资源管理及依赖优化策略。通过分析 AIRI 项目的实际配置，为 Electron 应用的安装程序构建提供全面指导。

## 应用基本信息配置

`electron-builder.yml` 文件定义了应用的核心元数据，包括应用 ID、产品名称和版本信息。这些配置直接影响安装包的标识和用户可见名称。

- **appId**: `ai.moeru.airi` — 应用的唯一标识符，用于系统识别和更新。
- **productName**: `AIRI` — 用户可见的产品名称，显示在安装向导和桌面快捷方式中。

这些信息与 `package.json` 中的版本号 `0.7.2-beta.3` 结合，确保安装包具备正确的版本标识。

**Section sources**
- [electron-builder.yml](file://apps/stage-tamagotchi/electron-builder.yml#L1-L3)
- [package.json](file://apps/stage-tamagotchi/package.json#L2-L4)

## 输出与资源管理

该部分配置了构建输出路径、打包文件范围及 ASAR 归档设置，确保仅包含必要资源并优化包体结构。

### 输出目录与文件过滤
```yaml
directories:
  output: dist
  buildResources: build

files:
  - out/**
  - resources/**
  - package.json
  - '!**/.vscode/*'
  - '!src/*'
  - '!electron.vite.config.{js,ts,mjs,cjs}'
  - '!vite.config.{js,ts,mjs,cjs}'
  - '!uno.config.{js,ts,mjs,cjs}'
  - '!{.eslintcache,eslint.config.ts,.yaml,dev-app-update.yml,CHANGELOG.md,README.md}'
  - '!{.env,.env.*,.npmrc,pnpm-lock.yaml}'
  - '!{tsconfig.json}'
```
- **output**: 构建产物输出至 `dist` 目录。
- **buildResources**: 构建资源（如图标、权限文件）位于 `build` 目录。
- **files**: 明确包含 `out`（编译后代码）、`resources`（静态资源）和 `package.json`，同时排除开发配置文件和源码，防止敏感信息泄露。

### ASAR 打包与解包
```yaml
asar: true
asarUnpack:
  - resources/**
  - out/renderer/**
```
- **asar**: 启用 ASAR 归档，将应用源码打包为单个文件以提高安全性和加载效率。
- **asarUnpack**: 指定 `resources` 和 `renderer` 目录不解包，确保资源文件可被直接访问，避免运行时性能问题。

**Section sources**
- [electron-builder.yml](file://apps/stage-tamagotchi/electron-builder.yml#L5-L35)

## 平台特定配置

### Windows (NSIS)
NSIS（Nullsoft Scriptable Install System）配置用于生成 Windows 安装程序，支持高度定制的安装向导。

```yaml
win:
  executableName: airi
nsis:
  artifactName: ${productName}-${version}-windows-${arch}-setup.${ext}
  shortcutName: ${productName}
  uninstallDisplayName: ${productName}
  createDesktopShortcut: always
  deleteAppDataOnUninstall: true
```
- **executableName**: 可执行文件命名为 `airi.exe`。
- **artifactName**: 安装包命名模板，包含产品名、版本、架构和扩展名。
- **createDesktopShortcut**: 始终创建桌面快捷方式，提升用户体验。
- **deleteAppDataOnUninstall**: 卸载时删除用户数据，确保系统清洁。

**Section sources**
- [electron-builder.yml](file://apps/stage-tamagotchi/electron-builder.yml#L37-L45)

### macOS (DMG)
macOS 配置包含权限声明和磁盘映像（DMG）设置，确保应用符合 Apple 安全规范。

```yaml
mac:
  entitlementsInherit: build/entitlements.mac.plist
  extendInfo:
    - NSDocumentsFolderUsageDescription: Application requests access to the user's Documents folder.
    - NSDownloadsFolderUsageDescription: Application requests access to the user's Downloads folder.
  notarize: false
  executableName: airi
dmg:
  artifactName: ${productName}-${version}-darwin-${arch}.${ext}
```
- **entitlementsInherit**: 继承 `entitlements.mac.plist` 中的权限，允许 JIT 执行和动态内存分配，满足 ONNX Runtime 等库的需求。
- **extendInfo**: 提供文件夹访问权限的用户提示。
- **notarize**: 禁用公证，适用于开发或内部发布。
- **artifactName**: DMG 安装包命名模板。

**Diagram sources**
- [entitlements.mac.plist](file://apps/stage-tamagotchi/build/entitlements.mac.plist#L1-L13)

**Section sources**
- [electron-builder.yml](file://apps/stage-tamagotchi/electron-builder.yml#L47-L56)

### Linux (DEB/RPM)
Linux 配置支持生成 DEB 和 RPM 包，适用于主流发行版。

```yaml
linux:
  target:
    - deb
    - rpm
  maintainer: moeru.ai
  category: Utility
  synopsis: 'AI VTuber/Waifu chatbot app inspired by Neuro-sama.'
  description: 'AIRI is an AI VTuber/Waifu chatbot supporting Live2D/VRM avatars, featuring human-like interactions and modular stage-based rendering.'
  executableName: airi
  artifactName: ${productName}-${version}-linux-${arch}.${ext}
  icon: build/icons/icon.png
```
- **target**: 同时生成 DEB 和 RPM 包。
- **maintainer**: 维护者信息。
- **category**: 应用分类为“工具”。
- **description**: 详细描述应用功能。
- **icon**: 指定应用图标路径。

**Section sources**
- [electron-builder.yml](file://apps/stage-tamagotchi/electron-builder.yml#L58-L70)

## 图标与权限配置

### 图标资源
- **Windows/Linux**: 通过 `icon: build/icons/icon.png` 指定图标。
- **macOS**: 图标通常在 `build` 目录下以 `.icns` 格式提供，由 electron-builder 自动查找。

### 权限管理
`entitlements.mac.plist` 文件包含 macOS 特定权限，允许应用使用 JIT 编译和动态库加载，这对于 ONNX Runtime 等高性能库至关重要。

```xml
<key>com.apple.security.cs.allow-jit</key>
<true/>
<key>com.apple.security.cs.allow-unsigned-executable-memory</key>
<true/>
```

**Section sources**
- [electron-builder.yml](file://apps/stage-tamagotchi/electron-builder.yml#L68)
- [entitlements.mac.plist](file://apps/stage-tamagotchi/build/entitlements.mac.plist#L5-L9)

## 安装包命名与构建脚本

项目通过脚本自动化安装包重命名和元数据生成，确保发布版本的一致性。

### 命名模板
- **Windows**: `${productName}-${version}-windows-${arch}-setup.exe`
- **macOS**: `${productName}-${version}-darwin-${arch}.dmg`
- **Linux**: `${productName}-${version}-linux-${arch}.deb/rpm`

### 构建脚本
- **rename-artifacts.ts**: 根据目标平台和版本重命名构建产物。
- **artifacts-metadata.ts**: 生成发布元数据，支持获取产品名、版本和文件名。
- **utils.ts**: 提供 `getElectronBuilderConfig()` 读取配置，`applyTemplateOfArtifactName()` 处理命名模板。

**Section sources**
- [scripts/utils.ts](file://apps/stage-tamagotchi/scripts/utils.ts#L38-L80)
- [scripts/rename-artifacts.ts](file://apps/stage-tamagotchi/scripts/rename-artifacts.ts#L0-L50)
- [scripts/artifacts-metadata.ts](file://apps/stage-tamagotchi/scripts/artifacts-metadata.ts#L0-L56)

## 依赖与性能优化

### 依赖管理
- **npmRebuild: false**: 禁用依赖重建，利用预构建的二进制文件（如 onnxruntime-web）加速构建。
- **package.json**: 明确列出生产依赖，如 `onnxruntime-web`、`pinia`、`vue` 等。

### 包体优化
- **asarUnpack**: 仅对 `resources` 和 `renderer` 解包，平衡安全与性能。
- **files 排除**: 移除开发依赖和配置文件，减小安装包体积。

**Section sources**
- [electron-builder.yml](file://apps/stage-tamagotchi/electron-builder.yml#L72)
- [package.json](file://apps/stage-tamagotchi/package.json#L30-L162)